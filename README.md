# Сервис Уведомлений

Уведомительный сервис предоставляет API для управления рассылками и получения статистики по отправленным сообщениям.

## API Эндпоинты

### Клиенты

Эндпоинт для управления клиентами.

- `GET /api/v1/client/`: Получить список всех клиентов.
- `POST /api/v1/client/`: Создать нового клиента.
- `GET /api/v1/client/{id}/`: Получить информацию о конкретном клиенте.
- `PUT /api/v1/client/{id}/`: Обновить информацию о конкретном клиенте.
- `PATCH /api/v1/dispatch/{id}/`: Частичное обновление информации о конкретном клиенте.
- `DELETE /api/v1/client/{id}/`: Удалить клиента.

### Рассылки

Эндпоинт для управления рассылками.

- `GET /api/v1/dispatch/`: Получить список всех рассылок.
- `POST /api/v1/dispatch/`: Создать новую рассылку.
- `GET /api/v1/dispatch/{id}/`: Получить информацию о конкретной рассылке.
- `PUT /api/v1/dispatch/{id}/`: Обновить информацию о конкретной рассылке.
- `PATCH /api/v1/dispatch/{id}/`: Частичное обновление информации о конкретной рассылке.
- `DELETE /api/v1/dispatch/{id}/`: Удалить рассылку.
  
### Аутентификация и авторизация
Для доступа к эндпоинтам требуется аутентификация и авторизация.

- `POST /api/v1/auth/users/`: Регистрация нового пользователя.
- `POST /api/v1/auth/token/login/`: Получение токена доступа после аутентификации.

!!АУНТЕФИКАЦИЯ ПРОИСХОДИТ ПУТЁМ ДОБАВЛЕНИЕ В ЗАГАЛОВОК Authorization `Token (ваш токен)`!!

## Рабочие процессы

### Отправка сообщений

Система планирует отправку сообщений с помощью Celery. Задача `my_task` запускается периодически с помощью Celery Beat. Эта задача каждую минуту проверяет не наступило ли время для какой либо рассылки и если да то отправляет сообщения клиентам, которые соответствуют условиям фильтрации.

### Отправка электронной почты

Каждый день система отправляет отчет о выполненных рассылках на указанный электронный адрес.

!!В файле `\notification_service\notifications\test.py`  замените `receiver_email = "example@mail.ru"` на нужный вам адресс!!

!!Создайте файл .env внутри директории `\notification_service\` и определите в нём `EMAIL_SENDER=ПочтаОтправления
EMAIL_PASSWORD=ПарольПриложения` для почты с которой будут отправляться сообщения!!


## Документация API

Документация API доступна на странице Swagger UI. Перейдите по ссылке `/docs/` для просмотра.

## Зависимости проекта

Зависимости проекта указаны в файле `requirements.txt`.

## Установка и запуск

1. Установите зависимости, запустив `pip install -r requirements.txt`.
2. Запустите Redis сервер.
3. Запустите Celery worker: `celery -A notification_service worker --loglevel=info -P eventlet`.
4. Запустите Celery Beat: `celery -A notification_service beat --loglevel=info`.
5. Запустите Django сервер: `python manage.py runserver`.

## Модели данных

### Dispatch (Рассылка)

| Поле            | Тип               | Описание                                                     |
|-----------------|-------------------|--------------------------------------------------------------|
| id              | AutoField         | Первичный ключ                                               |
| start_datetime  | DateTimeField     | Дата и время начала рассылки                                 |
| end_datetime    | DateTimeField     | Дата и время окончания рассылки                              |
| message         | TextField         | Текст сообщения для рассылки                                 |
| tag_filter      | CharField(40)     | Фильтр по тегу                                               |
| code_filter     | CharField(40)     | Фильтр по коду оператора связи                               |

### Client (Клиент)

| Поле               | Тип               | Описание                                                     |
|--------------------|-------------------|--------------------------------------------------------------|
| id                 | AutoField         | Первичный ключ                                               |
| phone_number       | CharField(12)     | Номер телефона клиента                                       |
| mobile_operator_code | CharField(10)   | Код мобильного оператора клиента                             |
| tag                | CharField(100)    | Тег клиента                                                  |
| timezone           | CharField(50)     | Часовой пояс клиента                                         |
| local_start_datetime | DateTimeField   | Локальное время начала доступности клиента для рассылок       |
| local_end_datetime | DateTimeField    | Локальное время окончания доступности клиента для рассылок    |

### Message (Сообщение)

| Поле            | Тип               | Описание                                                     |
|-----------------|-------------------|--------------------------------------------------------------|
| id              | AutoField         | Первичный ключ                                               |
| start_datetime  | DateTimeField     | Дата и время начала сообщения                                |
| end_datetime    | DateTimeField     | Дата и время окончания сообщения                             |
| status          | CharField(50)     | Статус сообщения                                             |
| dispatch        | ForeignKey        | Ссылка на рассылку, к которой относится сообщение             |
| client          | ForeignKey        | Ссылка на клиента, которому отправлено сообщение              |


## Дополнительные задачи

В проекте были реализованы следующие дополнительные задачи:

- **Добавление Swagger UI**: Реализовано открытие страницы со Swagger UI по адресу /docs/, где отображается описание разработанного API.

- **Административный Web UI**: Реализован административный интерфейс для управления рассылками и получения статистики по отправленным сообщениям с использованием Django REST Framework.

- **Ежедневная отправка статистики на email**: Добавлен дополнительный сервис, который ежедневно отправляет статистику по обработанным рассылкам на указанный email.

- **Обработка ошибок удаленного сервиса**: Обеспечена обработка ошибок и отложенная отправка запросов в случае недоступности удаленного сервиса. Задержки в работе внешнего сервиса не влияют на работу сервиса рассылок.

- **Добавление временного интервала для рассылок**: В сущность "рассылка" добавлено поле "временной интервал", позволяющее задать промежуток времени, в котором клиентам можно отправлять сообщения с учетом их локального времени.

- **Подробное логирование**: Реализовано подробное логирование на этапах обработки запросов, что позволяет быстро находить в логах всю необходимую информацию по id рассылки, id сообщения и id клиента и состоянию задачи в файле message_logs.log.


## Лицензия

Этот проект распространяется под лицензией BSD. См. файл `LICENSE` для получения дополнительной информации.
